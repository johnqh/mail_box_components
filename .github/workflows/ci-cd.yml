---
# CI/CD workflow for mail_box_components
# Automatically publishes to NPM when NPM_TOKEN is configured

name: CI/CD

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

permissions:
  contents: write      # For creating GitHub releases
  id-token: write      # For NPM provenance
  deployments: write   # For deployment tracking

jobs:
  cicd:
    uses: johnqh/workflows/.github/workflows/unified-cicd.yml@main
    with:
      npm-access: "public"
    secrets: inherit  # Pass all repository secrets

  # Validate all specialized packages (build, type-check, lint)
  validate-specialized:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package:
          - agriculture
          - analytics
          - automotive
          - collaboration
          - communication
          - construction
          - design
          - devops
          - documents
          - ecommerce
          - education
          - email
          - energy
          - entertainment
          - events
          - finance
          - fitness
          - food
          - gaming
          - government
          - healthcare
          - hr
          - insurance
          - interaction
          - iot
          - legal
          - logistics
          - manufacturing
          - marketing
          - media
          - monitoring
          - nonprofit
          - project-management
          - realestate
          - retail
          - scheduling
          - scientific
          - search
          - security
          - social
          - subscription
          - travel
          - visualization
          - web3
          - workflow

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        working-directory: ./packages/${{ matrix.package }}-components
        run: npm install --legacy-peer-deps
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Build package
        working-directory: ./packages/${{ matrix.package }}-components
        run: npm run build

      - name: Type check
        working-directory: ./packages/${{ matrix.package }}-components
        run: npm run type-check

      - name: Lint (if available)
        working-directory: ./packages/${{ matrix.package }}-components
        run: |
          if grep -q '"lint"' package.json; then
            npm run lint
          else
            echo "No lint script found, skipping..."
          fi

      - name: Test
        working-directory: ./packages/${{ matrix.package }}-components
        run: npm test

  # Publish specialized packages after main package and validation
  publish-specialized:
    needs: [cicd, validate-specialized]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package:
          - agriculture
          - analytics
          - automotive
          - collaboration
          - communication
          - construction
          - design
          - devops
          - documents
          - ecommerce
          - education
          - email
          - energy
          - entertainment
          - events
          - finance
          - fitness
          - food
          - gaming
          - government
          - healthcare
          - hr
          - insurance
          - interaction
          - iot
          - legal
          - logistics
          - manufacturing
          - marketing
          - media
          - monitoring
          - nonprofit
          - project-management
          - realestate
          - retail
          - scheduling
          - scientific
          - search
          - security
          - social
          - subscription
          - travel
          - visualization
          - web3
          - workflow

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Check if package needs publishing
        id: check-version
        run: |
          # Get published version from npm registry (empty if not published)
          PUBLISHED_VERSION=$(npm view @sudobility/${{ matrix.package }}-components version 2>/dev/null || echo "")

          # Get local version from package.json
          LOCAL_VERSION=$(node -p "require('./packages/${{ matrix.package }}-components/package.json').version")

          # Compare versions
          if [ "$PUBLISHED_VERSION" != "$LOCAL_VERSION" ]; then
            echo "changed=1" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Will publish ${{ matrix.package }}-components@$LOCAL_VERSION (npm: ${PUBLISHED_VERSION:-not published})"
          else
            echo "changed=0" >> $GITHUB_OUTPUT
            echo "âœ“ ${{ matrix.package }}-components@$LOCAL_VERSION already published"
          fi

      - name: Install dependencies
        if: steps.check-version.outputs.changed == '1'
        working-directory: ./packages/${{ matrix.package }}-components
        run: npm install --legacy-peer-deps
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Build package
        if: steps.check-version.outputs.changed == '1'
        working-directory: ./packages/${{ matrix.package }}-components
        run: npm run build

      - name: Publish to NPM
        if: steps.check-version.outputs.changed == '1'
        working-directory: ./packages/${{ matrix.package }}-components
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
