---
# CI/CD workflow for mail_box_components
# Automatically publishes to NPM when NPM_TOKEN is configured

name: CI/CD

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

permissions:
  contents: write      # For creating GitHub releases
  id-token: write      # For NPM provenance
  deployments: write   # For deployment tracking

jobs:
  cicd:
    uses: johnqh/workflows/.github/workflows/unified-cicd.yml@main
    with:
      npm-access: "restricted"
    secrets: inherit  # Pass all repository secrets

  # Publish specialized packages after main package succeeds
  publish-specialized:
    needs: cicd
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package:
          - agriculture
          - analytics
          - automotive
          - collaboration
          - communication
          - construction
          - design
          - devops
          - documents
          - ecommerce
          - education
          - email
          - energy
          - entertainment
          - events
          - finance
          - fitness
          - food
          - gaming
          - government
          - healthcare
          - hr
          - insurance
          - interaction
          - iot
          - legal
          - logistics
          - manufacturing
          - marketing
          - media
          - monitoring
          - nonprofit
          - project-management
          - realestate
          - retail
          - scheduling
          - scientific
          - search
          - security
          - social
          - travel
          - visualization
          - web3
          - workflow

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Check if package version changed
        id: check-version
        run: |
          if git diff HEAD^ HEAD -- packages/${{ matrix.package }}-components/package.json | grep -q '"version"'; then
            echo "changed=1" >> $GITHUB_OUTPUT
          else
            echo "changed=0" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        if: steps.check-version.outputs.changed == '1'
        working-directory: ./packages/${{ matrix.package }}-components
        run: npm install --legacy-peer-deps

      - name: Build package
        if: steps.check-version.outputs.changed == '1'
        working-directory: ./packages/${{ matrix.package }}-components
        run: npm run build

      - name: Publish to NPM
        if: steps.check-version.outputs.changed == '1'
        working-directory: ./packages/${{ matrix.package }}-components
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
